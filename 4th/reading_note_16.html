
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>16장 서버리스 노드 개발 · GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-theme-api/theme-api.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    
    <link rel="prev" href="../3th/reading_note_10.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">1주차</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="../1th/reading_note_1.html">
            
                <a href="../1th/reading_note_1.html">
            
                    
                    1장 노드 시작하기
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="../1th/reading_note_2.html">
            
                <a href="../1th/reading_note_2.html">
            
                    
                    2장 알아두어야 할 자바스크립트
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="../1th/reading_note_3.html">
            
                <a href="../1th/reading_note_3.html">
            
                    
                    3장 노드 기능
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">2주차</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="../2th/reading_note_4.html">
            
                <a href="../2th/reading_note_4.html">
            
                    
                    4장 http 모듈로 서버 만들기
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="../2th/reading_note_5.html">
            
                <a href="../2th/reading_note_5.html">
            
                    
                    5장 패키지 매니저
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="../2th/reading_note_6.html">
            
                <a href="../2th/reading_note_6.html">
            
                    
                    6장 익스프레스 웹 서버 만들기
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">3주차</li>
        
        
    
        <li class="chapter " data-level="4.1" data-path="../3th/reading_note_7.html">
            
                <a href="../3th/reading_note_7.html">
            
                    
                    7장 MySQL
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="../3th/reading_note_8.html">
            
                <a href="../3th/reading_note_8.html">
            
                    
                    8장 MongoDB
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.3" data-path="../3th/reading_note_9.html">
            
                <a href="../3th/reading_note_9.html">
            
                    
                    9장 익스프레스로 SNS 서비스 만들기
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.4" data-path="../3th/reading_note_10.html">
            
                <a href="../3th/reading_note_10.html">
            
                    
                    10장 웹 API 서버 만들기
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">4주차</li>
        
        
    
        <li class="chapter active" data-level="5.1" data-path="reading_note_16.html">
            
                <a href="reading_note_16.html">
            
                    
                    16장 서버리스 노드 개발
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >16장 서버리스 노드 개발</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="16&#xC7A5;-&#xC11C;&#xBC84;&#xB9AC;&#xC2A4;-&#xB178;&#xB4DC;-&#xAC1C;&#xBC1C;-&#x1F680;">16&#xC7A5; &#xC11C;&#xBC84;&#xB9AC;&#xC2A4; &#xB178;&#xB4DC; &#xAC1C;&#xBC1C; &#x1F680;</h1>
<p>[TOC]</p>
<h3 id="161-&#xC11C;&#xBC84;&#xB9AC;&#xC2A4;-&#xC774;&#xD574;&#xD558;&#xAE30;">16.1 &#xC11C;&#xBC84;&#xB9AC;&#xC2A4; &#xC774;&#xD574;&#xD558;&#xAE30;</h3>
<h4 id="&#xC11C;&#xBC84;&#xB9AC;&#xC2A4;serverless&#xB780;">&#xC11C;&#xBC84;&#xB9AC;&#xC2A4;(Serverless)&#xB780;?</h4>
<ul>
<li><p>&#xC11C;&#xBC84;&#xB97C; &#xD074;&#xB77C;&#xC6B0;&#xB4DC; &#xC11C;&#xBE44;&#xC2A4;&#xAC00; &#xB300;&#xC2E0; &#xAD00;&#xB9AC;&#xD574;&#xC8FC;&#xBBC0;&#xB85C; &#xAC1C;&#xBC1C;&#xC790;&#xB098; &#xC6B4;&#xC601;&#xC790;&#xAC00; &#xC11C;&#xBC84;&#xB97C; &#xAD00;&#xB9AC;&#xD558;&#xB294; &#xB370; &#xB4DC;&#xB294; &#xBD80;&#xB2F4;&#xC774; &#xC904;&#xC5B4;&#xB4E0;&#xB2E4;&#xB294; &#xC758;&#xBBF8;.</p>
</li>
<li><p><strong>&#xAC1C;&#xBC1C;&#xC790;&#xAC00; &#xC11C;&#xBE44;&#xC2A4; &#xB85C;&#xC9C1;&#xC5D0;&#xB9CC; &#xC9D1;&#xC911;&#xD560; &#xC218; &#xC788;&#xB294; &#xD658;&#xACBD; &#xC81C;&#xACF5;</strong></p>
</li>
<li>AWS EC2&#xB098; &#xAD6C;&#xAE00; &#xCEF4;&#xD4E8;&#xD2B8; &#xC5D4;&#xC9C4;&#xACFC;&#xB294; &#xB2EC;&#xB9AC; VM &#xC778;&#xC2A4;&#xD134;&#xC2A4;&#xB97C; &#xBBF8;&#xB9AC; &#xAD6C;&#xB9E4;&#xD558;&#xC9C0; &#xC54A;&#xC544;&#xB3C4; &#xB41C;&#xB2E4;.</li>
</ul>
<h4 id="&#xC11C;&#xBC84;&#xB9AC;&#xC2A4;-&#xC11C;&#xBE44;&#xC2A4;-&#xC608;&#xC2DC;">&#xC11C;&#xBC84;&#xB9AC;&#xC2A4; &#xC11C;&#xBE44;&#xC2A4; &#xC608;&#xC2DC;</h4>
<ul>
<li>AWS - &#xB78C;&#xB2E4;, API &#xAC8C;&#xC774;&#xD2B8;&#xC6E8;&#xC774;, S3</li>
<li>GCP - &#xC571; &#xC5D4;&#xC9C4;, &#xD30C;&#xC774;&#xC5B4;&#xBCA0;&#xC774;&#xC2A4;, &#xD074;&#xB77C;&#xC6B0;&#xB4DC; &#xD391;&#xC158;&#xC2A4;, &#xD074;&#xB77C;&#xC6B0;&#xB4DC; &#xC2A4;&#xD1A0;&#xB9AC;&#xC9C0;</li>
</ul>
<h4 id="&#xC11C;&#xBC84;&#xB9AC;&#xC2A4;&#xC758;-&#xC885;&#xB958;">&#xC11C;&#xBC84;&#xB9AC;&#xC2A4;&#xC758; &#xC885;&#xB958;</h4>
<ul>
<li>FaaS: &#xD2B9;&#xC815;&#xD55C; &#xB3D9;&#xC791;&#xC744; &#xC218;&#xD589;&#xD558;&#xB294; &#xB85C;&#xC9C1;&#xC744; &#xC800;&#xC7A5;&#xD558;&#xACE0; &#xC694;&#xCCAD;&#xC774; &#xB4E4;&#xC5B4;&#xC62C; &#xB54C; &#xB85C;&#xC9C1;&#xC744; &#xC2E4;&#xD589;&#xD558;&#xB294; &#xC11C;&#xBE44;&#xC2A4;. &#xC774;&#xBBF8;&#xC9C0; &#xB9AC;&#xC0AC;&#xC774;&#xC9D5; &#xB4F1;&#xC744; &#xD568;&#xC218;&#xB85C;. (&#xB78C;&#xB2E4;, &#xD074;&#xB77C;&#xC6B0;&#xB4DC; &#xD391;&#xC158;&#xC2A4;)</li>
<li>&#xD074;&#xB77C;&#xC6B0;&#xB4DC; &#xB370;&#xC774;&#xD130; &#xC800;&#xC7A5;&#xC18C;: &#xC774;&#xBBF8;&#xC9C0; &#xAC19;&#xC740; &#xB370;&#xC774;&#xD130;&#xB97C; &#xC800;&#xC7A5;&#xD558;&#xACE0; &#xBCF4;&#xC5EC;&#xC900;&#xB2E4;. &#xB178;&#xB4DC; &#xC11C;&#xBC84;&#xAC00; &#xB2E4;&#xB978; &#xC11C;&#xBC84;&#xC5D0; &#xBE44;&#xD574; &#xC815;&#xC801; &#xD30C;&#xC77C;&#xC744; &#xC81C;&#xACF5;&#xD558;&#xB294; &#xB370; &#xC720;&#xB9AC;&#xD558;&#xC9C0; &#xC54A;&#xC73C;&#xBBC0;&#xB85C; &#xC704;&#xC784;&#xD558;&#xBA74; &#xC88B;&#xC74C;. (S3, &#xD074;&#xB77C;&#xC6B0;&#xB4DC; &#xC2A4;&#xD1A0;&#xB9AC;&#xC9C0;)</li>
</ul>
<blockquote>
<p>Q: &#xB178;&#xB4DC;&#xAC00; &#xC774;&#xBBF8;&#xC9C0; &#xB9AC;&#xC0AC;&#xC774;&#xC9D5;&#xC744; &#xD558;&#xAE30; &#xBC84;&#xAC81;&#xACE0;, &#xB178;&#xB4DC; &#xC11C;&#xBC84;&#xAC00; &#xC815;&#xC801; &#xD30C;&#xC77C;&#xC744; &#xC81C;&#xACF5;&#xD558;&#xB294; &#xB370; &#xC720;&#xB9AC;&#xD558;&#xC9C0; &#xC54A;&#xAE30; &#xB54C;&#xBB38;&#xC5D0; &#xC4F0;&#xBA74; &#xC88B;&#xB2E4;&#xB294;&#xB370;, &#xC65C; &#xB178;&#xB4DC;&#xB294; &#xADF8;&#xAC78; &#xC798; &#xBABB;&#xD558;&#xB294; &#xAC78;&#xAE4C;.</p>
</blockquote>
<h3 id="162-aws-s3-&#xC0AC;&#xC6A9;&#xD558;&#xAE30;">16.2 AWS S3 &#xC0AC;&#xC6A9;&#xD558;&#xAE30;</h3>
<p><img src="https://github.com/swimjiy/node_study/blob/main/4th/img_01.png?raw=true" alt=""></p>
<h4 id="1-&#xBC84;&#xD0B7;&#xC744;-&#xB9CC;&#xB4E4;&#xC790;">1. &#xBC84;&#xD0B7;&#xC744; &#xB9CC;&#xB4E4;&#xC790;</h4>
<ol>
<li>&#xBA3C;&#xC800; &#xD68C;&#xC6D0;&#xAC00;&#xC785; &#xD558;&#xACE0; S3 &#xBC84;&#xD0B7; &#xB9CC;&#xB4E4;&#xAE30; &#xC2DC;&#xC791;</li>
<li>&#xBC84;&#xD0B7; &#xC774;&#xB984;(&#xACE0;&#xC720;)&#xACFC; &#xB9AC;&#xC804;(&#xD604;&#xC7AC; &#xC704;&#xCE58;&#xC640; &#xAC00;&#xAE4C;&#xC6B8; &#xC218;&#xB85D; &#xC88B;&#xC74C;)</li>
<li>&#xC6F9; &#xC11C;&#xBE44;&#xC2A4;&#xC5D0;&#xC11C; &#xC0AC;&#xC6A9;&#xD558;&#xAE30; &#xC704;&#xD574; &#xD37C;&#xBE14;&#xB9AD; &#xC561;&#xC138;&#xC2A4; &#xD5C8;&#xC6A9;</li>
<li>&#xAD8C;&#xD55C; &gt; &#xBC84;&#xD0B7; &#xC815;&#xCC45; &gt; &#xBC84;&#xD0B7; &#xC815;&#xCC45; &#xD3B8;&#xC9D1;&#xAE30;&#xC5D0; &#xC544;&#xB798;&#xC758; &#xCF54;&#xB4DC;&#xB97C; &#xCD94;&#xAC00;&#xD558;&#xC5EC; &#xAD8C;&#xD55C; &#xCD94;&#xAC00;</li>
</ol>
<pre><code class="lang-json">{
  &quot;Version&quot;: &quot;2012-10-17&quot;,
  &quot;Statement&quot;: [
    {
      &quot;Sid&quot;: &quot;AddPerm&quot;,
      &quot;Effect&quot;: &quot;Allow&quot;,
      &quot;Principal&quot;: &quot;*&quot;,
      &quot;Action&quot;: [
        &quot;s3:GetObject&quot;, # S3&#xC73C;&#xB85C;&#xBD80;&#xD130; &#xB370;&#xC774;&#xD130;&#xB97C; &#xAC00;&#xC838;&#xC624;&#xB294; &#xAD8C;&#xD55C;
        &quot;s3:PutObject&quot;  # S3&#xC5D0; &#xB370;&#xC774;&#xD130;&#xB97C; &#xB123;&#xB294; &#xAD8C;&#xD55C;
      ],
      &quot;Resource&quot;: &quot;arn:aws:s3:::nodebirdtestbucket/*&quot;
    }
  ]
}
</code></pre>
<ol>
<li>&#xACC4;&#xC815; &#xC774;&#xB984; &gt; &#xB0B4; &#xBCF4;&#xC548; &#xC790;&#xACA9; &#xC99D;&#xBA85; &gt; &#xC0C8; &#xC561;&#xC138;&#xC2A4; &#xD0A4; &#xB9CC;&#xB4E4;&#xAE30; &#xB85C; AWS &#xD0A4; &#xBC1C;&#xAE09; &#xBC1B;&#xAE30;</li>
</ol>
<h4 id="2-&#xB0B4;-&#xCF54;&#xB4DC;&#xC5D0;-s3&#xC744;-&#xC5F0;&#xACB0;&#xD558;&#xC790;">2. &#xB0B4; &#xCF54;&#xB4DC;&#xC5D0; S3&#xC744; &#xC5F0;&#xACB0;&#xD558;&#xC790;</h4>
<ol>
<li>&#xD544;&#xC694; &#xD328;&#xD0A4;&#xC9C0; &#xC124;&#xCE58;<ul>
<li>multer-s3: multer&#xC5D0;&#xC11C; s3&#xB85C; &#xC5C5;&#xB85C;&#xB4DC;</li>
<li>aws-sdk: aws &#xAE30;&#xB2A5;&#xC744; &#xB178;&#xB4DC;&#xC5D0;&#xC11C;&#xB3C4; &#xC0AC;&#xC6A9;&#xD560; &#xC218; &#xC788;&#xC74C;</li>
</ul>
</li>
</ol>
<pre><code class="lang-bash">$ npm i multer<span class="hljs-_">-s</span>3 aws-sdk
</code></pre>
<ol>
<li><code>.env</code> &#xC5D0; &#xC544;&#xAE4C; &#xC800;&#xC7A5;&#xD55C; AWS&#xD0A4; &#xCD94;&#xAC00;</li>
<li>&#xC544;&#xB798; &#xCF54;&#xB4DC; &#xCD94;&#xAC00;</li>
</ol>
<pre><code class="lang-javascript"><span class="hljs-comment">// routes/post.js</span>
...
const AWS = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;aws-sdk&apos;</span>);
<span class="hljs-keyword">const</span> multerS3 = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;multer-s3&apos;</span>);
...
<span class="hljs-comment">// AWS &#xC124;&#xC815;</span>
AWS.config.update({
    accessKeyId: process.env.AWSAccessKeyId,
    secretAccessKey: process.env.AWSSecretKey,
    region: <span class="hljs-string">&apos;ap-northeast-2&apos;</span>,
});

<span class="hljs-keyword">const</span> uploads = multer({
    <span class="hljs-comment">// multer&#xC758; storage &#xC635;&#xC158;&#xC744; multerS3&#xC73C;&#xB85C; &#xAD50;&#xCCB4;.</span>
    storage: multerS3({
        s3: <span class="hljs-keyword">new</span> AWS.S3(),
        bucket: <span class="hljs-string">&apos;nodebirdtestbucket&apos;</span>,
        key(req, file, cb) {
            cb(<span class="hljs-literal">null</span>, <span class="hljs-string">`original/<span class="hljs-subst">${Date.now()}</span><span class="hljs-subst">${path.basename(file.originalname)}</span>`</span>);
        }
    }),
    <span class="hljs-comment">// storage: multer.diskStorage({</span>
    <span class="hljs-comment">//     destination(req, file, cb) {</span>
    <span class="hljs-comment">//         cb(null, &apos;uploads/&apos;);</span>
    <span class="hljs-comment">//     }, filename(req, file, cb) {</span>
    <span class="hljs-comment">//         const ext = path.extname(file.originalname);</span>
    <span class="hljs-comment">//         cb(null, path.basename(file.originalname, ext) + Date.now() + ext);</span>
    <span class="hljs-comment">//     },</span>
    <span class="hljs-comment">// }),</span>
    limits: { fileSize: <span class="hljs-number">5</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> },
});

<span class="hljs-comment">// &#xC774;&#xBBF8;&#xC9C0; &#xD558;&#xB098;&#xB97C; &#xC5C5;&#xB85C;&#xB4DC;&#xBC1B;&#xC740; &#xB4A4; &#xC774;&#xBBF8;&#xC9C0;&#xC758; &#xC800;&#xC7A5; &#xACBD;&#xB85C;&#xB97C; &#xD074;&#xB77C;&#xC774;&#xC5B8;&#xD2B8;&#xB85C; &#xC751;&#xB2F5;</span>
router.post(<span class="hljs-string">&apos;/img&apos;</span>, isLoggedIn, uploads.single(<span class="hljs-string">&apos;img&apos;</span>), (req, res) =&gt; {
    <span class="hljs-built_in">console</span>.log(req.file);
    <span class="hljs-comment">// res.json({ url: `/img/${req.file.filename}` });</span>
    <span class="hljs-comment">// S3 &#xBC84;&#xD0B7; &#xC774;&#xBBF8;&#xC9C0; &#xC8FC;&#xC18C;&#xAC00; &#xB2F4;&#xACA8; &#xC788;&#xC73C;&#xBA70; &#xC774;&#xB97C; &#xD074;&#xB77C;&#xC774;&#xC5B8;&#xD2B8;&#xC5D0; &#xBCF4;&#xB0C4;.</span>
    res.json({ url: req.file.location });
});
...
</code></pre>
<h4 id="&#xACB0;&#xACFC;">&#xACB0;&#xACFC;</h4>
<p><img src="https://github.com/swimjiy/node_study/blob/main/4th/img_09.png?raw=true" alt=""></p>
<h3 id="163-aws-&#xB78C;&#xB2E4;-&#xC0AC;&#xC6A9;&#xD558;&#xAE30;">16.3 AWS &#xB78C;&#xB2E4; &#xC0AC;&#xC6A9;&#xD558;&#xAE30;</h3>
<h4 id="nodebird&#xC640;-aws-&#xC694;&#xCCAD;-&#xD504;&#xB85C;&#xC138;&#xC2A4;">[Nodebird&#xC640; AWS &#xC694;&#xCCAD; &#xD504;&#xB85C;&#xC138;&#xC2A4;]</h4>
<blockquote>
<p>Nodebird &#x2192; original &#xD3F4;&#xB354;&#xC5D0; &#xC774;&#xBBF8;&#xC9C0; &#xC5C5;&#xB85C;&#xB4DC; &#x2192; S3&#xC5D0; &#xB3C4;&#xCC29; &#x2192; S3&#xC5D0;&#xC11C; &#xB78C;&#xB2E4; &#xD2B8;&#xB9AC;&#xAC70; &#x2192; &#xB78C;&#xB2E4;&#xC5D0;&#xC11C; &#xB9AC;&#xC0AC;&#xC774;&#xC9D5;&#xB41C; &#xC774;&#xBBF8;&#xC9C0;&#xB97C; S3&#xC5D0; &#xC800;&#xC7A5;</p>
</blockquote>
<h4 id="1-&#xB78C;&#xB2E4;&#xC5D0;-&#xC62C;&#xB9B4;-&#xD568;&#xC218;-&#xB9CC;&#xB4E4;&#xAE30;">1. &#xB78C;&#xB2E4;&#xC5D0; &#xC62C;&#xB9B4; &#xD568;&#xC218; &#xB9CC;&#xB4E4;&#xAE30;</h4>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> AWS = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;aws-sdk&apos;</span>);
<span class="hljs-keyword">const</span> sharp = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;sharp&apos;</span>);

<span class="hljs-keyword">const</span> s3 = <span class="hljs-keyword">new</span> AWS.S3();

<span class="hljs-comment">// 1. handler: &#xB78C;&#xB2E4; &#xD638;&#xCD9C; &#xC2DC; &#xC2E4;&#xD589;&#xB418;&#xB294; &#xD568;&#xC218;.</span>
<span class="hljs-comment">// event: &#xD638;&#xCD9C; &#xC0C1;&#xD669;&#xC5D0; &#xB300;&#xD55C; &#xC815;&#xBCF4;, context: &#xC2E4;&#xD589;&#xB418;&#xB294; &#xD568;&#xC218; &#xD658;&#xACBD;&#xC5D0; &#xB300;&#xD55C; &#xC815;&#xBCF4;, callback(&#xC5D0;&#xB7EC; &#xC5EC;&#xBD80;, &#xBC18;&#xD658; &#xAC12;): &#xD568;&#xC218;&#xAC00; &#xC644;&#xB8CC;&#xB418;&#xC5C8;&#xB294;&#xC9C0;&#xB97C; &#xB78C;&#xB2E4;&#xC5D0;&#xAC8C; &#xC54C;&#xB9AC;&#xB294; &#xD568;&#xC218;.</span>
exports.handler = <span class="hljs-keyword">async</span> (event, context, callback) =&gt; {
  <span class="hljs-comment">// 2. event &#xAC1D;&#xCCB4;&#xB85C;&#xBD80;&#xD130; &#xBC84;&#xD0B7; &#xC774;&#xB984;(Bucket), &#xD30C;&#xC77C; &#xACBD;&#xB85C;(Key)&#xB97C; &#xBC1B;&#xC544;&#xC634;.</span>
  <span class="hljs-keyword">const</span> Bucket = event.Records[<span class="hljs-number">0</span>].s3.bucket.name;
  <span class="hljs-keyword">const</span> Key = event.Records[<span class="hljs-number">0</span>].s3.object.key;
  <span class="hljs-comment">// 3. Key&#xB97C; &#xD1B5;&#xD574; &#xD30C;&#xC77C;&#xBA85;, &#xD655;&#xC7A5;&#xC790;&#xB97C; &#xC5BB;&#xC74C;.</span>
  <span class="hljs-keyword">const</span> filename = Key.split(<span class="hljs-string">&apos;/&apos;</span>)[Key.split(<span class="hljs-string">&apos;/&apos;</span>).length - <span class="hljs-number">1</span>];
  <span class="hljs-keyword">const</span> ext = Key.split(<span class="hljs-string">&apos;.&apos;</span>)[Key.split(<span class="hljs-string">&apos;.&apos;</span>).length - <span class="hljs-number">1</span>];
  <span class="hljs-keyword">const</span> requiredFormat = ext === <span class="hljs-string">&apos;jpg&apos;</span> ? <span class="hljs-string">&apos;jpeg&apos;</span> : ext; <span class="hljs-comment">// sharp&#xC5D0;&#xC11C;&#xB294; jpg &#xB300;&#xC2E0; jpeg &#xC0AC;&#xC6A9;.</span>
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;name&apos;</span>, filename, <span class="hljs-string">&apos;ext&apos;</span>, ext);
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 4. &#xBC84;&#xD0B7;&#xC73C;&#xB85C;&#xBD80;&#xD130; &#xD30C;&#xC77C;&#xC744; &#xBD88;&#xB7EC;&#xC634;.</span>
    <span class="hljs-keyword">const</span> s3Object = <span class="hljs-keyword">await</span> s3.getObject({ Bucket, Key }).promise(); <span class="hljs-comment">// &#xBC84;&#xD37C;&#xB85C; &#xAC00;&#xC838;&#xC624;&#xAE30;.</span>
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;original&apos;</span>, s3Object.Body.length);
    <span class="hljs-comment">// 5. sharp &#xD568;&#xC218;&#xC5D0; &#xD30C;&#xC77C; &#xBC84;&#xD37C;(s3Object.Body) &#xB97C; &#xB123;&#xACE0;, resize &#xBA54;&#xC11C;&#xB4DC;&#xB85C; &#xD06C;&#xAE30; &#xC9C0;&#xC815;.</span>
    <span class="hljs-keyword">const</span> resizedImage = <span class="hljs-keyword">await</span> sharp(s3Object.Body)
      .resize(<span class="hljs-number">200</span>, <span class="hljs-number">200</span>, { fit: <span class="hljs-string">&apos;inside&apos;</span> })
      .toFormat(requiredFormat)
      .toBuffer(); <span class="hljs-comment">// &#xB9AC;&#xC0AC;&#xC774;&#xC9D5;&#xB41C; &#xC774;&#xBBF8;&#xC9C0; &#xACB0;&#xACFC;&#xB97C; &#xBC84;&#xD37C;&#xB85C; &#xCD9C;&#xB825;</span>
    <span class="hljs-comment">// 6. &#xB9AC;&#xC0AC;&#xC774;&#xC9D5;&#xB41C; &#xC774;&#xBBF8;&#xC9C0;&#xB97C; thumb &#xD3F4;&#xB354;&#xC5D0; &#xC800;&#xC7A5;</span>
    <span class="hljs-keyword">await</span> s3.putObject({
      Bucket,
      Key: <span class="hljs-string">`thumb/<span class="hljs-subst">${filename}</span>`</span>,
      Body: resizedImage,
    }).promise();
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;put&apos;</span>, resizedImage.length);
    <span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>, <span class="hljs-string">`thumb/<span class="hljs-subst">${filename}</span>`</span>);
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-built_in">console</span>.error(error);
    <span class="hljs-keyword">return</span> callback(error);
  }
}
</code></pre>
<h4 id="2-lightsail&#xB85C;-s3&#xC5D0;-&#xB78C;&#xB2E4;-&#xD30C;&#xC77C;-&#xC5C5;&#xB85C;&#xB4DC;&#xD558;&#xAE30;">2. Lightsail&#xB85C; S3&#xC5D0; &#xB78C;&#xB2E4; &#xD30C;&#xC77C; &#xC5C5;&#xB85C;&#xB4DC;&#xD558;&#xAE30;</h4>
<h5 id="&#xD1A0;&#xB9C9;-&#xAC1C;&#xB150;-lightsail">[&#xD1A0;&#xB9C9; &#xAC1C;&#xB150;: Lightsail]</h5>
<p><img src="https://github.com/swimjiy/node_study/blob/main/4th/img_03.png?raw=true" alt=""></p>
<ul>
<li><p>Lightsail &#xC4F0;&#xB294; &#xC774;&#xC720; -  <code>sharp</code>&#xAC00; &#xC708;&#xB3C4;&#xC6A9;&#xACFC; &#xB9E5;&#xC6A9;, &#xB9AC;&#xB205;&#xC2A4;&#xC6A9;&#xC73C;&#xB85C; &#xAD6C;&#xBD84;&#xB418;&#xBBC0;&#xB85C; &#xBE4C;&#xB4DC;&#xD560; &#xB54C; &#xB9AC;&#xB205;&#xC2A4; &#xD658;&#xACBD;&#xC5D0;&#xC11C; &#xD574;&#xC57C; &#xB78C;&#xB2E4;(&#xB9AC;&#xB205;&#xC2A4;)&#xB791; &#xD638;&#xD658;&#xB428;.</p>
</li>
<li><p>15.3&#xC5D0; Lightsail &#xAC00;&#xC785; &#xBC29;&#xBC95; &#xB098;&#xC640;&#xC788;&#xC74C;.</p>
</li>
<li><p>&#xAC00;&#xC785; &#xC635;&#xC158; - &#xC704;&#xCE58;: &#xC11C;&#xC6B8;, &#xC774;&#xBBF8;&#xC9C0; &#xD50C;&#xB7AB;&#xD3FC;: Linux, &#xC774;&#xBBF8;&#xC9C0; &#xBE14;&#xB8E8;&#xD504;&#xB9B0;&#xD2B8;: Node.js</p>
</li>
<li><p>&#xCC38;&#xACE0; - Lightsail&#xC740; &#xCCAB; &#xB2EC;&#xC740; &#xBB34;&#xB8CC;&#xC9C0;&#xB9CC; &#xC774;&#xD6C4; &#xB9E4;&#xB2EC; &#xCD5C;&#xC18C; 3.5 &#xB2EC;&#xB7EC; &#xBD80;&#xACFC;. &#xBB34;&#xB8CC; &#xBC30;&#xD3EC; &#xC11C;&#xBE44;&#xC2A4;&#xB85C;&#xB294; Heroku, OpenShift &#xB4F1;&#xC774; &#xC788;&#xACE0; AWS&#xB3C4; &#xAC00;&#xC785; &#xD6C4; 1&#xB144;&#xAC04; &#xD2B9;&#xC815; &#xC9C0;&#xC5ED;&#xC5D0; &#xD55C;&#xD574; EC2 &#xBB34;&#xB8CC; &#xD2F0;&#xC5B4; &#xC81C;&#xACF5;.</p>
</li>
</ul>
<h5 id="2-1-github&#xC5D0;-&#xC544;&#xAE4C;-&#xB9CC;&#xB4E4;&#xC5B4;-&#xB454;-&#xD3F4;&#xB354;-&#xB808;&#xD3EC;-&#xC0DD;&#xC131;&#xD574;&#xC11C;-&#xC800;&#xC7A5;&#xD558;&#xAE30;">2-1. github&#xC5D0; &#xC544;&#xAE4C; &#xB9CC;&#xB4E4;&#xC5B4; &#xB454; &#xD3F4;&#xB354; &#xB808;&#xD3EC; &#xC0DD;&#xC131;&#xD574;&#xC11C; &#xC800;&#xC7A5;&#xD558;&#xAE30;.</h5>
<p><a href="https://github.com/swimjiy/aws-upload" target="_blank">https://github.com/swimjiy/aws-upload</a></p>
<h5 id="2-2-lightsail-&#xC778;&#xC2A4;&#xD134;&#xC2A4;-ssh&#xC5D0;-&#xC811;&#xC18D;&#xD574;&#xC11C;-&#xB808;&#xD3EC;-clone-&#xBC1B;&#xACE0;-zip&#xD30C;&#xC77C;-&#xB9CC;&#xB4E4;&#xAE30;">2-2. Lightsail &#xC778;&#xC2A4;&#xD134;&#xC2A4; SSH&#xC5D0; &#xC811;&#xC18D;&#xD574;&#xC11C; &#xB808;&#xD3EC; clone &#xBC1B;&#xACE0; zip&#xD30C;&#xC77C; &#xB9CC;&#xB4E4;&#xAE30;.</h5>
<p><img src="https://github.com/swimjiy/node_study/blob/main/4th/img_04.png?raw=true" alt=""></p>
<pre><code class="lang-bash">$ <span class="hljs-built_in">clone</span> &#xD558;&#xACE0; npm i &#xD558;&#xACE0;...
$ sudo zip -r aws-upload.zip ./*
</code></pre>
<h5 id="2-3-lightsail&#xC5D0;&#xC11C;-s3&#xC73C;&#xB85C;-&#xD30C;&#xC77C;-&#xC5C5;&#xB85C;&#xB4DC;&#xD558;&#xAE30;">2-3 Lightsail&#xC5D0;&#xC11C; S3&#xC73C;&#xB85C; &#xD30C;&#xC77C; &#xC5C5;&#xB85C;&#xB4DC;&#xD558;&#xAE30;</h5>
<pre><code class="lang-bash"><span class="hljs-comment"># 1. &#xC5C5;&#xB85C;&#xB4DC;&#xC5D0; &#xD544;&#xC694;&#xD55C; aws-cli &#xC124;&#xCE58; + &#xC124;&#xC815;</span>
<span class="hljs-comment"># https://docs.aws.amazon.com/ko_kr/cli/latest/userguide/install-cliv2-linux.html</span>
$ curl <span class="hljs-string">&quot;https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip&quot;</span> -o <span class="hljs-string">&quot;awscliv2.zip&quot;</span>
$ sudo unzip awscliv2.zip
$ sudo ./aws/install
$ aws configure
AWS Access Key ID [None]: &#xD0A4; &#xC544;&#xC774;&#xB514;
AWS Secret Access Key [None]: &#xC2DC;&#xD06C;&#xB9BF; &#xC561;&#xC138;&#xC2A4; &#xC544;&#xC774;&#xB514;
Default region name [None]: ap-northeast-2
Default output format [None]: json

<span class="hljs-comment"># 2. s3 &#xBC84;&#xD0B7;&#xC5D0; &#xC62C;&#xB9AC;&#xAE30;</span>
$ aws s3 cp <span class="hljs-string">&quot;aws-upload.zip&quot;</span> s3://nodebirdtestbucket <span class="hljs-comment"># &#xBC84;&#xD0B7;&#xBA85;</span>
</code></pre>
<h4 id="3-&#xB78C;&#xB2E4;-&#xC11C;&#xBE44;&#xC2A4;-&#xC124;&#xC815;">3. &#xB78C;&#xB2E4; &#xC11C;&#xBE44;&#xC2A4; &#xC124;&#xC815;</h4>
<h5 id="3-1-&#xC0DD;&#xC131;-&#xBC0F;-&#xD30C;&#xC77C;-&#xC5C5;&#xB85C;&#xB4DC;">3-1. &#xC0DD;&#xC131; &#xBC0F; &#xD30C;&#xC77C; &#xC5C5;&#xB85C;&#xB4DC;</h5>
<p>&#xD568;&#xC218; &#xC0DD;&#xC131;</p>
<p><img src="https://github.com/swimjiy/node_study/blob/main/4th/img_05.png?raw=true" alt=""></p>
<p>&#xD568;&#xC218; &#xCF54;&#xB4DC; &gt; &#xC6B0;&#xCE21; &#xC791;&#xC5C5; &#xB4DC;&#xB86D;&#xB2E4;&#xC6B4; &gt; Amazon S3&#xC5D0;&#xC11C; &#xD30C;&#xC77C; &#xC5C5;&#xB85C;&#xB4DC;</p>
<pre><code>https://nodebirdtestbucket.s3.ap-northeast-2.amazonaws.com/aws-upload.zip
</code></pre><h5 id="3-2-&#xAE30;&#xBCF8;-&#xC124;&#xC815;-&#xD3B8;&#xC9D1;">3-2. &#xAE30;&#xBCF8; &#xC124;&#xC815; &#xD3B8;&#xC9D1;</h5>
<p>&#xADFC;&#xB370; &#xCC45;&#xC774;&#xB791; &#xC880; &#xB2E4;&#xB984;. &#xD578;&#xB4E4;&#xB7EC;&#xAC00; &#xC5C6;&#xC74C;.</p>
<p><img src="https://github.com/swimjiy/node_study/blob/main/4th/img_06.png?raw=true" alt=""></p>
<h5 id="3-3-&#xD2B8;&#xB9AC;&#xAC70;-&#xCD94;&#xAC00;">3-3. &#xD2B8;&#xB9AC;&#xAC70; &#xCD94;&#xAC00;</h5>
<p>s3&#xC5D0; &#xC774;&#xBBF8;&#xC9C0;&#xB97C; &#xC5C5;&#xB85C;&#xB4DC; &#xD560; &#xB54C;&#xB9C8;&#xB2E4; &#xB78C;&#xB2E4; &#xD568;&#xC218; &#xC2E4;&#xD589;.</p>
<p><img src="https://github.com/swimjiy/node_study/blob/main/4th/img_07.png?raw=true" alt=""></p>
<h4 id="4-nodebird&#xC5D0;&#xC11C;-&#xB78C;&#xB2E4;-&#xC801;&#xC6A9;">4. Nodebird&#xC5D0;&#xC11C; &#xB78C;&#xB2E4; &#xC801;&#xC6A9;</h4>
<pre><code class="lang-javascript"><span class="hljs-comment">// routes/post.js</span>
...
router.post(<span class="hljs-string">&apos;/img&apos;</span>, isLoggedIn, uploads.single(<span class="hljs-string">&apos;img&apos;</span>), (req, res) =&gt; {
    <span class="hljs-built_in">console</span>.log(req.file);
    <span class="hljs-comment">// &#xAE30;&#xC874; &#xC8FC;&#xC18C;&#xC5D0;&#xC11C; original &#xD3F4;&#xB354; &#xBD80;&#xBD84;&#xC744; thumb &#xD3F4;&#xB354;&#xB85C; &#xAD50;&#xCCB4;</span>
    <span class="hljs-keyword">const</span> originalUrl = req.file.location;
    <span class="hljs-keyword">const</span> url = originalUrl.replace(<span class="hljs-regexp">/\/original\//</span>, <span class="hljs-string">&apos;/thumb/&apos;</span>);
    res.json({ url, originalUrl });
});
...
</code></pre>
<pre><code class="lang-html">// views/main.html
&lt;div class=&quot;twit-img&quot;&gt;
  &lt;img
    src=&quot;{{twit.img}}&quot;
    alt=&quot;&#xC12C;&#xB124;&#xC77C;&quot;
    &lt;!-- &#xB9AC;&#xC0AC;&#xC774;&#xC9D5; &#xC774;&#xBBF8;&#xC9C0;&#xB97C; &#xBD88;&#xB7EC;&#xC624;&#xB294; &#xB370; &#xC2E4;&#xD328;&#xD558;&#xBA74; &#xC6D0;&#xBCF8; &#xC774;&#xBBF8;&#xC9C0; &#xC0AC;&#xC6A9; --&gt;
    onerror=&quot;this.src = this.src.replace(/\/thumb\//, &apos;/original/&apos;);&quot;
  &gt;
&lt;/div&gt;

axios.post(&apos;/post/img&apos;, formData)
  .then((res) =&gt; {
    // &#xBBF8;&#xB9AC;&#xAE30; &#xC2DC;&#xC5D0;&#xB294; &#xC6D0;&#xBCF8;&#xC744; &#xBCF4;&#xC5EC;&#xC8FC;&#xACE0;, &#xC800;&#xC7A5; &#xD6C4;&#xC5D0; &#xB9AC;&#xC0AC;&#xC774;&#xC9D5; &#xC774;&#xBBF8;&#xC9C0;&#xB97C; &#xBCF4;&#xC5EC;&#xC90C;.
    document.getElementById(&apos;img-url&apos;).value = res.data.url;
    // &#xAE30;&#xC874; &#xCF54;&#xB4DC;: document.getElementById(&apos;img-preview&apos;).src = res.data.url;
    document.getElementById(&apos;img-preview&apos;).src = res.data.originalUrl;
    document.getElementById(&apos;img-preview&apos;).style.display = &apos;inline&apos;;
  })
  .catch((err) =&gt; {
    console.error(err);
  });
});
</code></pre>
<h4 id="&#xACB0;&#xACFC;">&#xACB0;&#xACFC;</h4>
<p><img src="https://github.com/swimjiy/node_study/blob/main/4th/img_08.png?raw=true" alt=""></p>
<h3 id="164-&#xAD6C;&#xAE00;-&#xD074;&#xB77C;&#xC6B0;&#xB4DC;-&#xC2A4;&#xD1A0;&#xB9AC;&#xC9C0;-&#xC0AC;&#xC6A9;&#xD558;&#xAE30;">16.4 &#xAD6C;&#xAE00; &#xD074;&#xB77C;&#xC6B0;&#xB4DC; &#xC2A4;&#xD1A0;&#xB9AC;&#xC9C0; &#xC0AC;&#xC6A9;&#xD558;&#xAE30;</h3>
<h3 id="165-&#xAD6C;&#xAE00;-&#xD074;&#xB77C;&#xC6B0;&#xB4DC;-&#xD391;&#xC158;&#xC2A4;-&#xC0AC;&#xC6A9;&#xD558;&#xAE30;">16.5 &#xAD6C;&#xAE00; &#xD074;&#xB77C;&#xC6B0;&#xB4DC; &#xD391;&#xC158;&#xC2A4; &#xC0AC;&#xC6A9;&#xD558;&#xAE30;</h3>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            

        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"16장 서버리스 노드 개발","level":"5.1","depth":1,"previous":{"title":"10장 웹 API 서버 만들기","level":"4.4","depth":1,"path":"3th/reading_note_10.md","ref":"3th/reading_note_10.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["theme-api"],"pluginsConfig":{"theme-api":{"languages":[],"split":true,"theme":"dark"},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"4th/reading_note_16.md","mtime":"2021-02-19T15:08:59.971Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2021-02-21T14:57:58.012Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-theme-api/theme-api.js"></script>
        
    

    </body>
</html>

